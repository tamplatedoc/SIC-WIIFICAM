<!DOCTYPE html>
<html>
<head>
    <title>Pendaftaran FIP - VBank SoftGrammer</title>
</head>
<body>
    <h1>Pendaftaran FaceIDPay (FIP)</h1>
    <video id="webcam" autoplay style="width:320px; height:240px;"></video><br>
    <button onclick="captureAndEnroll()">Daftarkan Wajah FIP</button>
    <p id="status_message"></p>

    <script>
        const video = document.getElementById('webcam');
        const statusMsg = document.getElementById('status_message');
        
        // Asumsi data user sudah didapat dari sesi
        const CURRENT_USER_ID = 'nasabah_001'; 
        const CURRENT_USER_NAME = 'Budi Santoso';
        
        // 1. Inisialisasi kamera web
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => video.srcObject = stream)
            .catch(err => {
                statusMsg.textContent = "Error: Gagal akses kamera. Pastikan browser Anda mengizinkan akses.";
                console.error(err);
            });

        function captureAndEnroll() {
            statusMsg.textContent = "Sedang memproses... Harap tunggu.";
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Konversi gambar ke Base64
            const faceImageData = canvas.toDataURL('image/jpeg').split(',')[1];
            
            // Kirim data ke Backend VBank
            fetch('/api/enroll_face', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    userId: CURRENT_USER_ID, 
                    faceImageData: faceImageData,
                    nama: CURRENT_USER_NAME,
                    data_diri: {alamat: 'Jl. Merdeka', usia: 25, gender: 'L'}
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    statusMsg.textContent = "✅ Pendaftaran FIP Berhasil!";
                } else {
                    statusMsg.textContent = "❌ Pendaftaran Gagal: " + data.message;
                }
            })
            .catch(err => {
                statusMsg.textContent = "❌ Gagal Terhubung ke Server VBank.";
            });
        }
    </script>
</body>
</html>
