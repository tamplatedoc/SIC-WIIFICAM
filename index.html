<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FIP Virtual Bank — Demo</title>
  <meta name="description" content="Virtual e-Banking demo with FIP face-enroll, DBO admin and merchant simulator" />
  <style>
    :root{--bg:#f7f9fb;--card:#fff;--accent:#0b84ff;--muted:#6b7280}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);margin:0;color:#0b1220}
    header{background:linear-gradient(90deg,#073b8c22,transparent);padding:14px 20px;border-bottom:1px solid #e6eef8}
    .container{max-width:1100px;margin:22px auto;padding:0 18px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 22px rgba(12,24,40,0.06)}
    h1,h2{margin:6px 0}
    label{display:block;font-weight:600;margin-top:8px}
    input,select,textarea,button{font-family:inherit}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8;margin-top:6px}
    button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    nav a{margin-right:12px;color:var(--muted);text-decoration:none}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .small{font-size:0.9rem;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:#044caa;font-weight:700}
    footer{margin:36px 0 80px;color:var(--muted);font-size:0.9rem}
    .flex{display:flex;align-items:center;gap:8px}
    .center{text-align:center}
    .hidden{display:none}
    video{border-radius:8px;border:1px solid #e6eef8}
    img.avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 6px 18px rgba(10,20,40,0.08)}
  </style>
</head>
<body>
  <header>
    <div class="container flex" style="justify-content:space-between;align-items:center">
      <div>
        <h1 style="margin:0">FIP Virtual Bank — Demo</h1>
        <div class="small">Landing • Register / Login • Customer Dashboard • DBO Admin • Merchant</div>
      </div>
      <nav id="mainNav"></nav>
    </div>
  </header>

  <main class="container">

    <!-- Pages (single-file SPA using hash routes) -->

    <!-- Landing -->
    <section id="page_landing" class="card">
      <h2>Selamat datang di FIP Virtual Bank (Demo)</h2>
      <p class="small">Aplikasi demo untuk: pendaftaran akun, login, pendaftaran wajah (FIP) via kamera website, dashboard e-banking simple, DBO admin untuk top-up & monitoring, dan merchant sederhana untuk simulasi belanja.</p>
      <div class="row" style="margin-top:12px">
        <div class="col card">
          <h3>Daftar Akun Baru</h3>
          <label>Nama lengkap</label>
          <input id="reg_name" placeholder="Ahmad" />
          <label>Email</label>
          <input id="reg_email" placeholder="nama@contoh.com" />
          <label>Password</label>
          <input id="reg_password" type="password" />
          <label>Role</label>
          <select id="reg_role">
            <option value="customer">Customer</option>
            <option value="merchant">Merchant</option>
            <option value="admin">Admin (DBO)</option>
          </select>
          <label>Initial Top-up (IDR)</label>
          <input id="reg_topup" type="number" placeholder="100000" />
          <button id="btnRegister">Daftar & Simpan ke Firestore</button>
          <p id="reg_msg" class="small"></p>
        </div>

        <div class="col card">
          <h3>Login</h3>
          <label>Email</label>
          <input id="login_email" />
          <label>Password</label>
          <input id="login_password" type="password" />
          <button id="btnLogin">Masuk</button>
          <p id="login_msg" class="small"></p>
        </div>
      </div>
    </section>

    <!-- Customer Dashboard -->
    <section id="page_dashboard" class="card hidden">
      <div class="flex" style="justify-content:space-between">
        <div style="display:flex;gap:12px;align-items:center">
          <img id="dash_avatar" class="avatar" src="" alt="avatar" />
          <div>
            <h2 id="dash_name" style="margin:0">Nama</h2>
            <div class="small">ID: <span id="dash_uid"></span> • <span id="dash_role" class="badge">Customer</span></div>
          </div>
        </div>
        <div class="center">
          <div class="small">Saldo Anda</div>
          <h2 id="dash_balance">Rp 0</h2>
        </div>
      </div>

      <hr />

      <div class="row">
        <div class="col card">
          <h3>Transfer / Bayar (Manual)</h3>
          <label>Tujuan (user_id)</label>
          <input id="tx_to" placeholder="user001" />
          <label>Jumlah (IDR)</label>
          <input id="tx_amount" type="number" />
          <label>Keterangan</label>
          <input id="tx_note" />
          <button id="btnTransfer">Kirim Transfer (simulasi, update Firestore)</button>
          <p id="tx_msg" class="small"></p>
        </div>

        <div class="col card">
          <h3>FIP - Pendaftaran Wajah (Camera)</h3>
          <p class="small">Gunakan kamera untuk mengambil foto wajah lalu kirim ke server /enroll (server Anda harus aktif pada <code>http://localhost:3000</code> atau ganti baseURL di pengaturan).</p>
          <video id="camera_preview" width="320" height="240" autoplay muted></video>
          <div style="margin-top:8px">
            <button id="btnStartCam">Buka Kamera</button>
            <button id="btnCapture">Ambil Foto & Enroll</button>
            <button id="btnStopCam" class="secondary">Tutup Kamera</button>
          </div>
          <p id="fip_msg" class="small"></p>
        </div>
      </div>

      <hr />

      <div class="row">
        <div class="col card">
          <h3>Riwayat Transaksi</h3>
          <div id="dash_tx">-</div>
        </div>

        <div class="col card">
          <h3>Notifikasi</h3>
          <div id="dash_notif">Belum ada notifikasi</div>
        </div>
      </div>
    </section>

    <!-- Merchant Shop -->
    <section id="page_shop" class="card hidden">
      <h2>Toko Simulasi</h2>
      <div class="small">Tambahkan barang ke keranjang, checkout akan memanggil endpoint pembayaran (di backend Anda) atau melakukan simulasi pembayaran.</div>
      <div style="margin-top:12px" id="shop_items"></div>
      <hr />
      <div class="card">
        <h3>Keranjang</h3>
        <div id="cart_list">Belum ada item</div>
        <p class="small">Total: <strong id="cart_total">Rp 0</strong></p>
        <label>Gunakan metode pembayaran</label>
        <select id="pay_method"><option value="simulate">Simulasi (Firestore)</option><option value="fip">FIP (POST /fip_pay)</option></select>
        <div id="pay_fip_opts" class="hidden">
          <p class="small">Untuk FIP: butuh foto pembeli (camera) yang akan dikirim ke server /fip_pay untuk mencocokkan wajah dan mengurangi saldo.</p>
        </div>
        <button id="btnCheckout">Checkout</button>
        <div id="checkout_msg" class="small"></div>
      </div>
    </section>

    <!-- DBO Admin -->
    <section id="page_admin" class="card hidden">
      <h2>DBO - Admin Panel</h2>
      <div class="small">Kelola user, top-up, status FIP, dan pantau transaksi.</div>
      <div style="margin-top:12px">
        <button id="btn_admin_get_users">Muat Semua User (Firestore)</button>
        <div id="admin_users">-</div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>Top-up Cepat</h3>
        <label>user_id</label>
        <input id="admin_topup_user" />
        <label>amount</label>
        <input id="admin_topup_amount" type="number" />
        <button id="btn_admin_topup">Kirim Top-up (panggil /api/admin/topup)</button>
        <div id="admin_topup_msg" class="small"></div>
      </div>
    </section>

    <footer>
      <div class="small">Petunjuk: ganti variable <code>FIREBASE_CONFIG</code> sesuai project Anda, dan <code>API_BASE</code> ke alamat server Node.js Anda (default: http://localhost:3000). Pastikan Firebase rules untuk testing mengizinkan read/write (atau gunakan Authentication pada produksi).</div>
    </footer>

  </main>

  <script type="module">
  // ======================== CONFIG ========================
  // Ganti dengan Firebase config project Anda (modular v9+)
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAya-7QEtbflW7jh_EoPclFBQ43VnrKZrM",
    authDomain: "rdw-katalog.firebaseapp.com",
    projectId: "rdw-katalog",
    storageBucket: "rdw-katalog.firebasestorage.app",
    messagingSenderId: "506572005524",
    appId: "1:506572005524:web:43b7d27f2c33a1d4071481"
  };

  // Base URL server Node.js (ganti sesuai env)
  const API_BASE = 'https://12e7f5acfe39.ngrok-free.app';

  // ======================== IMPORTS ========================
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
  import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, query, where, updateDoc, serverTimestamp, orderBy, limit } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

  const app = initializeApp(FIREBASE_CONFIG);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ======================== Simple SPA router ========================
  const pages = {
    '': 'page_landing',
    '#/': 'page_landing',
    '#/dashboard': 'page_dashboard',
    '#/shop': 'page_shop',
    '#/admin': 'page_admin'
  };

  function showPage(hash){
    Object.values(pages).forEach(id => document.getElementById(id).classList.add('hidden'));
    const id = pages[hash] || pages[''];
    document.getElementById(id).classList.remove('hidden');
    renderNav();
  }

  function renderNav(){
    const nav = document.getElementById('mainNav');
    nav.innerHTML = '';
    const user = window._CURRENT_USER || null;
    const links = [];
    links.push({t:'Home',h:'#/'});
    if(user){
      links.push({t:'Dashboard',h:'#/dashboard'});
      links.push({t:'Shop',h:'#/shop'});
      if(user.role==='admin') links.push({t:'DBO',h:'#/admin'});
      links.push({t:'Logout',h:'#logout'});
    } else {
      links.push({t:'Login/Register',h:'#/'});
    }
    links.forEach(l => {
      const a = document.createElement('a');
      a.href = l.h;
      a.textContent = l.t;
      a.onclick = (ev) => {
        if(l.h==='#logout'){ ev.preventDefault(); doLogout(); return; }
        setTimeout(()=>showPage(l.h),10);
      };
      nav.appendChild(a);
    });
  }

  window.addEventListener('hashchange', () => showPage(location.hash));
  showPage(location.hash);

  // ======================== Utilities ========================
  function toCurrency(idr){
    try{
      return new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR' }).format(Number(idr||0));
    }catch(e){return 'Rp ' + (idr||0)}
  }

  function uidShort(uid){ return uid ? uid.substring(0,8) : '-'; }

  // ======================== Register / Login ========================
  document.getElementById('btnRegister').addEventListener('click', async ()=>{
    const name = document.getElementById('reg_name').value.trim();
    const email = document.getElementById('reg_email').value.trim();
    const password = document.getElementById('reg_password').value;
    const role = document.getElementById('reg_role').value;
    const topup = Number(document.getElementById('reg_topup').value) || 0;
    const msg = document.getElementById('reg_msg');
    msg.textContent = 'Mendaftarkan...';
    if(!name||!email||!password){ msg.textContent='Isi semua field'; return; }
    try{
      // buat user di Firebase Auth (optional) dan simpan data di Firestore
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      const uid = cred.user.uid;
      await setDoc(doc(db,'users',uid), {
        user_id: uid,
        nama: name,
        email: email,
        role: role,
        saldo: topup,
        face_id_status: role==='customer' ? 'Nonaktif' : 'Nonaktif',
        created_at: serverTimestamp()
      });
      // catat transaksi topup jika >0
      if(topup>0){
        await addDoc(collection(db,'transactions'),{
          user_id: uid, amount: topup, type:'CREDIT', transaction_id:'TOPUP_' + Date.now(), timestamp: serverTimestamp()
        });
      }
      msg.textContent = 'Registrasi sukses. Anda akan login otomatis.';
      // set current user
      await onLoginSuccess({ uid, nama: name, role, email });
    }catch(err){
      console.error(err); msg.textContent = 'Error: ' + (err.message || err);
    }
  });

  document.getElementById('btnLogin').addEventListener('click', async ()=>{
    const email = document.getElementById('login_email').value.trim();
    const password = document.getElementById('login_password').value;
    const msg = document.getElementById('login_msg');
    msg.textContent = 'Logging in...';
    try{
      const cred = await signInWithEmailAndPassword(auth, email, password);
      const uid = cred.user.uid;
      const udoc = await getDoc(doc(db,'users',uid));
      if(!udoc.exists()){ msg.textContent='Akun tidak ditemukan di Firestore.'; return; }
      const data = udoc.data();
      await onLoginSuccess({ uid, ...data });
      msg.textContent = 'Login sukses.';
    }catch(err){ console.error(err); msg.textContent = 'Error: ' + (err.message || err); }
  });

  async function onLoginSuccess(userData){
    // set global state
    window._CURRENT_USER = userData;
    renderNav();
    location.hash = '#/dashboard';
    // populate dashboard
    document.getElementById('dash_name').textContent = userData.nama || userData.email;
    document.getElementById('dash_uid').textContent = userData.user_id || userData.uid || userData.uidShort || '-';
    document.getElementById('dash_role').textContent = (userData.role||'customer');
    document.getElementById('dash_balance').textContent = toCurrency(userData.saldo||0);
    document.getElementById('dash_avatar').src = 'https://ui-avatars.com/api/?name=' + encodeURIComponent(userData.nama || userData.email) + '&background=0b84ff&color=fff&size=128';
    // fetch recent transactions
    await loadUserTransactions(userData.user_id || userData.uid);
  }

  async function doLogout(){
    await signOut(auth).catch(()=>{});
    window._CURRENT_USER = null; renderNav(); location.hash = '#/';
  }

  // ======================== Transactions (simple Firestore-based transfer) ========================
  document.getElementById('btnTransfer').addEventListener('click', async ()=>{
    const to = document.getElementById('tx_to').value.trim();
    const amount = Number(document.getElementById('tx_amount').value);
    const note = document.getElementById('tx_note').value;
    const msg = document.getElementById('tx_msg');
    if(!window._CURRENT_USER){ msg.textContent='Login dahulu'; return; }
    if(!to||!amount||amount<=0){ msg.textContent='Tujuan dan jumlah tidak valid'; return; }
    msg.textContent = 'Memproses transfer...';
    try{
      // simple transaction: decrease sender, increase recipient inside transaction via cloud function normally
      // For demo: write a debit and credit tx and update balances naïvely (not safe for concurrency)
      const fromId = window._CURRENT_USER.user_id || window._CURRENT_USER.uid;
      const fromRef = doc(db,'users',fromId);
      const toRef = doc(db,'users',to);
      const fromSnap = await getDoc(fromRef);
      const toSnap = await getDoc(toRef);
      if(!toSnap.exists()){ msg.textContent='Tujuan tidak ditemukan'; return; }
      const fromBal = (fromSnap.data().saldo||0);
      if(fromBal < amount){ msg.textContent='Saldo tidak cukup'; return; }
      // update balances (demo only)
      await updateDoc(fromRef, { saldo: fromBal - amount });
      await updateDoc(toRef, { saldo: (toSnap.data().saldo||0) + amount });
      // log transactions
      await addDoc(collection(db,'transactions'),{ user_id: fromId, amount: -amount, type: 'DEBIT', transaction_id:'TX_' + Date.now(), note, timestamp: serverTimestamp() });
      await addDoc(collection(db,'transactions'),{ user_id: to, amount: amount, type: 'CREDIT', transaction_id:'TX_' + Date.now(), note, timestamp: serverTimestamp() });
      msg.textContent = 'Transfer berhasil.';
      // refresh
      const newBalanceSnap = await getDoc(fromRef);
      document.getElementById('dash_balance').textContent = toCurrency(newBalanceSnap.data().saldo||0);
      await loadUserTransactions(fromId);
    }catch(err){ console.error(err); msg.textContent = 'Error: '+(err.message||err); }
  });

  // ======================== Load transactions
  async function loadUserTransactions(uid){
    try{
      const q = query(collection(db,'transactions'), where('user_id','==', uid));
      const snap = await getDocs(q);
      const list = [];
      snap.forEach(d=> list.push(d.data()));
      const el = document.getElementById('dash_tx');
      if(list.length===0) { el.textContent = 'Belum ada transaksi'; return; }
      const rows = list.slice(0,20).map(t=> `<div class=card style="margin-bottom:8px"><div><strong>${t.type}</strong> ${t.amount}</div><div class=small>${t.transaction_id || ''} • ${t.note||''}</div></div>`).join('');
      el.innerHTML = rows;
    }catch(e){ console.error(e); }
  }

  // ======================== Camera + FIP Enroll
  let mediaStream = null;
  const video = document.getElementById('camera_preview');
  document.getElementById('btnStartCam').addEventListener('click', async ()=>{
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({ video: { width:320, height:240 }, audio:false });
      video.srcObject = mediaStream;
      document.getElementById('fip_msg').textContent = 'Kamera aktif.';
    }catch(err){ console.error(err); document.getElementById('fip_msg').textContent = 'Gagal akses kamera: '+err.message; }
  });
  document.getElementById('btnStopCam').addEventListener('click', ()=>{
    if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; video.srcObject=null; document.getElementById('fip_msg').textContent='Kamera dimatikan';
  });

  document.getElementById('btnCapture').addEventListener('click', async ()=>{
    const msg = document.getElementById('fip_msg');
    if(!mediaStream){ msg.textContent = 'Buka kamera dahulu'; return; }
    if(!window._CURRENT_USER){ msg.textContent = 'Login dahulu'; return; }
    msg.textContent = 'Mengambil foto...';
    // capture frame to canvas
    const canvas = document.createElement('canvas'); canvas.width=320; canvas.height=240; const ctx = canvas.getContext('2d'); ctx.drawImage(video,0,0,canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.8); // data:image/jpeg;base64,...
    const base64 = dataUrl.split('base64,')[1];
    // call backend /enroll
    msg.textContent = 'Mengirim ke server enroll...';
    try{
      const payload = { user_id: window._CURRENT_USER.user_id || window._CURRENT_USER.uid, image_base64: base64 };
      const res = await fetch(API_BASE + '/enroll', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      const resJson = await res.json();
      if(res.ok){
        msg.textContent = 'Enroll sukses: ' + (resJson.message || JSON.stringify(resJson));
        // update user face_id_status in Firestore
        await updateDoc(doc(db,'users', window._CURRENT_USER.user_id), { face_id_status: 'Aktif' });
        // show notification in dashboard
        const notif = document.getElementById('dash_notif'); notif.innerHTML = `<div class=badge>FIP Aktif</div> Pendaftaran wajah berhasil`;
      } else {
        msg.textContent = 'Enroll gagal: ' + (resJson.message || JSON.stringify(resJson));
      }
    }catch(err){ console.error(err); msg.textContent = 'Error enroll: ' + (err.message||err); }
  });

  // ======================== Shop (merchant sample)
  const sampleItems = [
    { id:'p1', name:'Pulsa 50k', price:50000 },
    { id:'p2', name:'Voucher Game 100k', price:100000 },
    { id:'p3', name:'T-shirt FIP', price:75000 }
  ];
  let CART = [];
  function renderShop(){
    const container = document.getElementById('shop_items');
    container.innerHTML = sampleItems.map(it => `<div class="card" style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${it.name}</strong><div class=small>${toCurrency(it.price)}</div></div><div><button onclick="addToCart('${it.id}')">Tambah</button></div></div></div>`).join('');
    renderCart();
  }
  window.addToCart = function(id){ const it = sampleItems.find(s=>s.id===id); CART.push(it); renderCart(); }
  function renderCart(){
    const el = document.getElementById('cart_list');
    if(CART.length===0) { el.innerHTML = 'Keranjang kosong'; document.getElementById('cart_total').textContent = toCurrency(0); return; }
    const rows = CART.map((c,i)=> `<div class=small>${i+1}. ${c.name} — ${toCurrency(c.price)}</div>`).join('');
    el.innerHTML = rows;
    const total = CART.reduce((s,i)=> s + i.price,0);
    document.getElementById('cart_total').textContent = toCurrency(total);
  }
  document.getElementById('pay_method').addEventListener('change', (e)=>{ document.getElementById('pay_fip_opts').classList.toggle('hidden', e.target.value!=='fip'); });

  document.getElementById('btnCheckout').addEventListener('click', async ()=>{
    const method = document.getElementById('pay_method').value;
    const msg = document.getElementById('checkout_msg');
    if(CART.length===0){ msg.textContent='Keranjang kosong'; return; }
    if(!window._CURRENT_USER){ msg.textContent='Login dulu'; return; }
    const total = CART.reduce((s,i)=> s + i.price,0);
    msg.textContent = 'Memproses pembayaran...';
    if(method==='simulate'){
      // do simple Firestore debit
      try{
        const uid = window._CURRENT_USER.user_id;
        const userRef = doc(db,'users',uid);
        const snap = await getDoc(userRef);
        const bal = snap.data().saldo || 0;
        if(bal < total){ msg.textContent = 'Saldo tidak cukup'; return; }
        await updateDoc(userRef,{ saldo: bal - total });
        await addDoc(collection(db,'transactions'),{ user_id: uid, amount: -total, type:'DEBIT', transaction_id:'SHOP_' + Date.now(), timestamp: serverTimestamp() });
        CART = []; renderCart(); msg.textContent = 'Pembayaran simulasi berhasil.';
        document.getElementById('dash_balance').textContent = toCurrency(bal - total);
      }catch(err){ console.error(err); msg.textContent = 'Error: ' + err.message; }
    } else if(method==='fip'){
      // need camera capture (reuse canvas) and call backend /fip_pay
      try{
        if(!mediaStream){ msg.textContent='Buka kamera terlebih dahulu (di Dashboard) untuk memverifikasi wajah.'; return; }
        const canvas = document.createElement('canvas'); canvas.width=320; canvas.height=240; canvas.getContext('2d').drawImage(video,0,0,320,240);
        const base64 = canvas.toDataURL('image/jpeg',0.8).split('base64,')[1];
        const payload = { image_base64: base64, amount: total.toString(), shop_tx_id: 'SHOP_' + Date.now() };
        const res = await fetch(API_BASE + '/fip_pay', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const data = await res.json();
        if(res.ok){ msg.textContent = 'Pembayaran FIP sukses: ' + (data.message || JSON.stringify(data)); CART=[]; renderCart(); await loadUserTransactions(window._CURRENT_USER.user_id); }
        else { msg.textContent = 'Pembayaran FIP gagal: ' + (data.message || JSON.stringify(data)); }
      }catch(err){ console.error(err); msg.textContent = 'Error saat FIP pay: ' + err.message; }
    }
  });

  // ======================== Admin: load users & topup via server
  document.getElementById('btn_admin_get_users').addEventListener('click', async ()=>{
    const el = document.getElementById('admin_users'); el.textContent = 'Loading...';
    try{
      const snap = await getDocs(collection(db,'users'));
      const rows = [];
      snap.forEach(d=> rows.push(d.data()));
      if(rows.length===0) el.textContent = 'Tidak ada user';
      else el.innerHTML = '<table><thead><tr><th>user_id</th><th>nama</th><th>role</th><th>saldo</th><th>fip</th></tr></thead><tbody>' + rows.map(r=> `<tr><td>${r.user_id}</td><td>${r.nama||'-'}</td><td>${r.role||'-'}</td><td>${r.saldo||0}</td><td>${r.face_id_status||'Nonaktif'}</td></tr>`).join('') + '</tbody></table>';
    }catch(err){ console.error(err); el.textContent = 'Error: ' + err.message; }
  });

  document.getElementById('btn_admin_topup').addEventListener('click', async ()=>{
    const user = document.getElementById('admin_topup_user').value.trim();
    const amount = Number(document.getElementById('admin_topup_amount').value);
    const el = document.getElementById('admin_topup_msg');
    if(!user||!amount){ el.textContent = 'Isi user dan amount'; return; }
    try{
      const res = await fetch(API_BASE + '/api/admin/topup', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ user_id: user, amount }) });
      const data = await res.json();
      if(res.ok) el.textContent = 'Top-up sukses: ' + (data.message || JSON.stringify(data)); else el.textContent = 'Gagal: ' + (data.message || JSON.stringify(data));
    }catch(err){ console.error(err); el.textContent = 'Error: ' + err.message; }
  });

  // ======================== Init
  renderShop();
  renderNav();

  </script>
</body>
</html>


