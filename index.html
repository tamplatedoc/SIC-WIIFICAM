<!DOCTYPE html>
<html>
<head>
  <title>ESP32 WebRTC Stream</title>
</head>
<body>
  <h2>ESP32-CAM WebRTC Stream</h2>
  <video id="video" autoplay playsinline></video>

  <script>
    const video = document.getElementById('video');
    const ws = new WebSocket("esp32-webrtc-server-production.up.railway.app");

    const pc = new RTCPeerConnection();

    pc.ontrack = (event) => {
      video.srcObject = event.streams[0];
    };

    ws.onmessage = async (event) => {
      const data = JSON.parse(event.data);
      if(data.sdp){
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        if(data.sdp.type === "offer"){
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ sdp: pc.localDescription }));
        }
      }
      if(data.ice){
        try { await pc.addIceCandidate(data.ice); } catch(e) {}
      }
    };

    pc.onicecandidate = (event) => {
      if(event.candidate){
        ws.send(JSON.stringify({ ice: event.candidate }));
      }
    };
  </script>
</body>
</html>
